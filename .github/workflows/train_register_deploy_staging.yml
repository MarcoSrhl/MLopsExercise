name: Candidate to Staging

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "ml/**"
      - "backend/**"
      - ".github/workflows/train_register_deploy_staging.yml"

jobs:
  train_register:
    runs-on: ubuntu-latest
    outputs:
      result_json: ${{ steps.train.outputs.result_json }}
      model_version: ${{ steps.train.outputs.model_version }}
      accuracy: ${{ steps.train.outputs.accuracy }}
      run_id: ${{ steps.train.outputs.run_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ML deps
        run: |
          pip install -r ml/requirements.txt

      - name: Train + register in MLflow (capture JSON only)
        id: train
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.DAGSHUB_MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          MODEL_NAME: churn-model
          DATA_VERSION: "dvc:v1"
        run: |
          set -e
          python ml/train_and_register.py | tee train_full.log

          JSON_LINE="$(grep -Eo '\{.*\}' train_full.log | tail -n 1)"
          if [ -z "$JSON_LINE" ]; then
            echo "Could not find JSON output in train_full.log"
            cat train_full.log
            exit 1
          fi

          # Extract fields for downstream jobs
          MODEL_VERSION="$(python - <<'PY'
          import json, sys
          obj = json.loads(sys.stdin.read())
          print(obj["model_version"])
          PY
          <<< "$JSON_LINE")"

          ACCURACY="$(python - <<'PY'
          import json, sys
          obj = json.loads(sys.stdin.read())
          print(obj["accuracy"])
          PY
          <<< "$JSON_LINE")"

          RUN_ID="$(python - <<'PY'
          import json, sys
          obj = json.loads(sys.stdin.read())
          print(obj["run_id"])
          PY
          <<< "$JSON_LINE")"

          echo "result_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$JSON_LINE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "model_version=$MODEL_VERSION" >> "$GITHUB_OUTPUT"
          echo "accuracy=$ACCURACY" >> "$GITHUB_OUTPUT"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

          echo "Captured: model_version=$MODEL_VERSION accuracy=$ACCURACY run_id=$RUN_ID"

      - name: Evaluate gate
        env:
          # set this to whatever your assignment wants; 0.80 lets your ~0.82 model pass
          ACCURACY_THRESHOLD: "0.80"
        run: |
          printf '%s' '${{ steps.train.outputs.result_json }}' | python ml/evaluate.py

  deploy_staging:
    needs: train_register
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python (for MLflow stage transition)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install MLflow (for stage transition)
        run: |
          pip install -q mlflow

      - name: Promote model version to Staging
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.DAGSHUB_MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          MODEL_NAME: churn-model
          MODEL_VERSION: ${{ needs.train_register.outputs.model_version }}
        run: |
          python - <<'PY'
          import os
          import mlflow
          from mlflow.tracking import MlflowClient

          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])
          token = os.environ["MLFLOW_TRACKING_TOKEN"]
          os.environ["MLFLOW_TRACKING_USERNAME"] = token
          os.environ["MLFLOW_TRACKING_PASSWORD"] = token

          name = os.environ["MODEL_NAME"]
          version = os.environ["MODEL_VERSION"]

          client = MlflowClient()
          client.transition_model_version_stage(
              name=name,
              version=version,
              stage="Staging",
              archive_existing_versions=True,
          )

          print(f"Promoted {name} v{version} -> Staging (archived existing Staging)")
          PY

      - name: Build + push backend image (staging)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -e
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          docker build -t "$DOCKERHUB_USERNAME/churn-backend:staging" backend
          docker push "$DOCKERHUB_USERNAME/churn-backend:staging"

      - name: Deploy to staging (placeholder)
        run: |
          echo "Deploy step placeholder"

  staging_smoke_test:
    needs: deploy_staging
    runs-on: ubuntu-latest
    steps:
      - name: Smoke test (placeholder)
        run: |
          echo "Smoke test placeholder"
